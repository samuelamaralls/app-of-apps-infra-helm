##CONF DIND
#gitlabUrl: "http://gitlab.thesams.site/"
#runnerRegistrationToken: "GR1348941FtwcvVyXQRHzx4Ce9jbm"
#
#serviceAccount:
#  create: true
#  name: gitlab-runner
#
#rbac:
#  create: true
#
#podSecurityContext:
#  runAsUser: 0
#
#containerSecurityContext:
#  privileged: true
#  allowPrivilegeEscalation: true
#
#config: |
#  concurrent = 10
#  check_interval = 0
#  
#  [session_server]
#    session_timeout = 1800
#  
#  [[runners]]
#    name = "my-gitlab-runner"
#    executor = "kubernetes"
#    environment = ["DOCKER_DRIVER=overlay2", "DOCKER_TLS_CERTDIR="]
#    
#    [runners.kubernetes]
#      namespace = "gitlab-runner"
#      privileged = true
#      image_pull_policy = "IfNotPresent"
#      poll_timeout = 180
#      service_account = "gitlab-runner"
#      helper_image = "gitlab/gitlab-runner-helper:x86_64-latest"
#      
#      # Sidecar Docker-in-Docker
#      [[runners.kubernetes.services]]
#        name = "docker"
#        image = "docker:20-dind"
#        privileged = true
#        command = ["--host=tcp://0.0.0.0:2375", "--tls=false"]
#
#    [runners.feature_flags]
#      FF_ENABLE_JOB_TRACE_LOG_ROTATION = true
#
#tags: "default"

gitlabUrl: "http://gitlab.thesams.site/"
runnerRegistrationToken: "GR1348941FtwcvVyXQRHzx4Ce9jbm"

serviceAccount:
  create: true
  name: gitlab-runner

rbac:
  create: true

securityContext:
  privileged: true
  allowPrivilegeEscalation: true
  capabilities:
    add:
      - SYS_ADMIN

config: |
  concurrent = 10
  check_interval = 0
  
  [session_server]
    session_timeout = 1800
  
  [[runners]]
    name = "my-gitlab-runner"
    executor = "kubernetes"
    environment = []
    
    [runners.kubernetes]
      namespace = "gitlab-runner"
      privileged = true
      image_pull_policy = "IfNotPresent"
      poll_timeout = 180
      service_account = "gitlab-runner"
      helper_image = "gitlab/gitlab-runner-helper:x86_64-latest"

    [runners.feature_flags]
      FF_ENABLE_JOB_TRACE_LOG_ROTATION = true

tags: "default"

extraContainers:
  - name: buildkitd
    image: moby/buildkit:rootless
    args:
      - --addr
      - unix:///run/user/1000/buildkit/buildkitd.sock
      - --addr
      - tcp://0.0.0.0:1234
      - --oci-worker-no-process-sandbox
    ports:
      - containerPort: 1234
    securityContext:
      # Needs Kubernetes >= 1.19
      seccompProfile:
        type: Unconfined
      # Needs Kubernetes >= 1.30
      appArmorProfile:
        type: Unconfined
      # To change UID/GID, you need to rebuild the image
      runAsUser: 1000
      runAsGroup: 1000
    volumeMounts:
      # Dockerfile has `VOLUME /home/user/.local/share/buildkit` by default too,
      # but the default VOLUME does not work with rootless on Google's Container-Optimized OS
      # as it is mounted with `nosuid,nodev`.
      # https://github.com/moby/buildkit/issues/879#issuecomment-1240347038
      - mountPath: /home/user/.local/share/buildkit
        name: buildkitd

volumes:
  - name: buildkitd
    emptyDir: {}
extraObjects:
  - apiVersion: v1
    kind: Service
    metadata:
      name: buildkitd
      namespace: gitlab-runner
    spec:
      selector:
        app: gitlab-runner
      ports:
        - protocol: TCP
          port: 1234
          targetPort: 1234